<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokéRandomizer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #000000; } /* Pure black track */
        ::-webkit-scrollbar-thumb { background: #262626; border-radius: 4px; } /* Dark grey thumb */
        ::-webkit-scrollbar-thumb:hover { background: #404040; } /* Slightly lighter hover */
        
        /* Type Colors (Standard set) */
        .type-bg-normal { background-color: #A8A77A; color: white; }
        .type-bg-fire { background-color: #EE8130; color: white; }
        .type-bg-water { background-color: #6390F0; color: white; }
        .type-bg-electric { background-color: #F7D02C; color: black; }
        .type-bg-grass { background-color: #7AC74C; color: white; }
        .type-bg-ice { background-color: #96D9D6; color: black; }
        .type-bg-fighting { background-color: #C22E28; color: white; }
        .type-bg-poison { background-color: #A33EA1; color: white; }
        .type-bg-ground { background-color: #E2BF65; color: black; }
        .type-bg-flying { background-color: #A98FF3; color: white; }
        .type-bg-psychic { background-color: #F95587; color: white; }
        .type-bg-bug { background-color: #A6B91A; color: white; }
        .type-bg-rock { background-color: #B6A136; color: white; }
        .type-bg-ghost { background-color: #735797; color: white; }
        .type-bg-dragon { background-color: #6F35FC; color: white; }
        .type-bg-dark { background-color: #705746; color: white; }
        .type-bg-steel { background-color: #B7B7CE; color: black; }
        .type-bg-fairy { background-color: #D685AD; color: black; }

        /* Type Text Colors for SVG */
        .type-text-normal { color: #A8A77A; }
        .type-text-fire { color: #EE8130; }
        .type-text-water { color: #6390F0; }
        .type-text-electric { color: #F7D02C; }
        .type-text-grass { color: #7AC74C; }
        .type-text-ice { color: #96D9D6; }
        .type-text-fighting { color: #C22E28; }
        .type-text-poison { color: #A33EA1; }
        .type-text-ground { color: #E2BF65; }
        .type-text-flying { color: #A98FF3; }
        .type-text-psychic { color: #F95587; }
        .type-text-bug { color: #A6B91A; }
        .type-text-rock { color: #B6A136; }
        .type-text-ghost { color: #735797; }
        .type-text-dragon { color: #6F35FC; }
        .type-text-dark { color: #705746; }
        .type-text-steel { color: #B7B7CE; }
        .type-text-fairy { color: #D685AD; }
        
        /* Animations */
        .pokeball-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* Utility to hide horizontal scrollbar on controls */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Quiz Specific Styling */
        .silhouette {
            filter: brightness(0) contrast(0);
            transition: filter 0.5s ease-in-out;
        }
        .revealed {
            filter: brightness(1) contrast(1);
        }
    </style>
</head>
<body class="bg-black text-neutral-200 font-sans min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-neutral-900/80 backdrop-blur-sm border-b border-neutral-800 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-red-500/10 p-2 rounded-full">
                    <i class="ph-fill ph-pokeball text-red-500 text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight leading-tight">PokéRandomizer <span class="text-red-500">Z-A</span></h1>
                    <p class="text-xs text-neutral-500 font-medium">Using Real PokeAPI Data</p>
                </div>
            </div>
            <a href="https://github.com" target="_blank" class="text-neutral-400 hover:text-white transition p-2 hover:bg-neutral-800 rounded-lg">
                <i class="ph-fill ph-github-logo text-2xl"></i>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-5xl mx-auto px-4 py-8 w-full">

        <!-- Controls Card -->
        <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-1 shadow-2xl shadow-black/80 mb-8">
            
            <!-- 1. Main Tabs: Randomizer, Team Builder, Quiz -->
            <div class="flex p-1 bg-black/50 rounded-xl border border-neutral-800/50 mb-4 gap-1 hide-scrollbar">
                <button onclick="switchMainTab('randomizer')" id="main-tab-randomizer" class="main-tab-btn flex-shrink-0 flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 bg-neutral-800 text-white shadow-sm ring-1 ring-white/10">
                    <i class="ph-fill ph-shuffle text-lg"></i> Randomizer
                </button>
                <button onclick="switchMainTab('team')" id="main-tab-team" class="main-tab-btn flex-shrink-0 flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 text-neutral-400 hover:text-neutral-200 hover:bg-neutral-800/50">
                    <i class="ph-fill ph-users-three text-lg"></i> Team Builder
                </button>
                <button onclick="switchMainTab('quiz')" id="main-tab-quiz" class="main-tab-btn flex-shrink-0 flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 text-neutral-400 hover:text-neutral-200 hover:bg-neutral-800/50">
                    <i class="ph-fill ph-question text-lg"></i> Quiz
                </button>
            </div>

            <!-- 2. Randomizer Sub Tabs (Only visible when main-tab is Randomizer) -->
            <div id="randomizerSubTabs" class="px-5 mb-5 animate-fade-in">
                <div class="flex overflow-x-auto bg-black/50 rounded-xl border border-neutral-800/50 gap-1 p-1 hide-scrollbar">
                    <button onclick="switchSubTab('pokemon')" id="sub-tab-pokemon" class="sub-tab-btn flex-shrink-0 flex-1 min-w-[100px] py-2 text-xs md:text-sm font-semibold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 bg-neutral-800 text-white shadow-sm">
                        <i class="ph-fill ph-paw-print text-base"></i> Pokémon
                    </button>
                    <button onclick="switchSubTab('abilities')" id="sub-tab-abilities" class="sub-tab-btn flex-shrink-0 flex-1 min-w-[100px] py-2 text-xs md:text-sm font-semibold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 text-neutral-400 hover:text-neutral-200 hover:bg-neutral-800/50">
                        <i class="ph-fill ph-lightning text-base"></i> Abilities
                    </button>
                    <button onclick="switchSubTab('moves')" id="sub-tab-moves" class="sub-tab-btn flex-shrink-0 flex-1 min-w-[100px] py-2 text-xs md:text-sm font-semibold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 text-neutral-400 hover:text-neutral-200 hover:bg-neutral-800/50">
                        <i class="ph-fill ph-sword text-base"></i> Moves
                    </button>
                    <button onclick="switchSubTab('items')" id="sub-tab-items" class="sub-tab-btn flex-shrink-0 flex-1 min-w-[100px] py-2 text-xs md:text-sm font-semibold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 text-neutral-400 hover:text-neutral-200 hover:bg-neutral-800/50">
                        <i class="ph-fill ph-bag text-base"></i> Items
                    </button>
                    <button onclick="switchSubTab('superRandomPoke')" id="sub-tab-superRandomPoke" class="sub-tab-btn flex-shrink-0 flex-1 min-w-[100px] py-2 text-xs md:text-sm font-semibold rounded-lg transition-all duration-300 flex items-center justify-center gap-2 text-neutral-400 hover:text-neutral-200 hover:bg-neutral-800/50">
                        <i class="ph-fill ph-magic-wand text-base"></i> Random Setups
                    </button>
                </div>
            </div>
            
            <!-- 3. Quiz Difficulty Selector (Only visible when main-tab is Quiz) -->
            <div id="quizControls" class="px-5 pb-5 hidden animate-fade-in">
                <label for="quizDifficulty" class="block text-xs font-semibold text-neutral-400 uppercase tracking-wider mb-2 ml-1">Difficulty</label>
                <select id="quizDifficulty" class="w-full bg-black border border-neutral-700 text-neutral-200 text-sm rounded-xl px-4 py-3 pr-10 focus:ring-2 focus:ring-red-500/50 focus:border-red-500 focus:outline-none transition shadow-sm appearance-none cursor-pointer group-hover:border-neutral-600">
                    <option value="easy">Easy (Gen 1-3)</option>
                    <option value="medium">Medium (Gen 4-6)</option>
                    <option value="hard">Hard (Gen 7-9)</option>
                </select>
            </div>

            <!-- 4. Filters & Action Row -->
            <div id="controls-row" class="px-5 pb-5 flex flex-col gap-4">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- Game Filter -->
                    <div class="w-full md:col-span-1 lg:col-span-2">
                        <label for="genSelect" class="block text-xs font-semibold text-neutral-400 uppercase tracking-wider mb-2 ml-1">Region / Game</label>
                        <div class="relative group">
                            <select id="genSelect" class="w-full bg-black border border-neutral-700 text-neutral-200 text-sm rounded-xl px-4 py-3 pr-10 focus:ring-2 focus:ring-red-500/50 focus:border-red-500 focus:outline-none transition shadow-sm appearance-none cursor-pointer group-hover:border-neutral-600">
                                <option value="all">National Dex (All)</option>
                                <option value="gen1">Gen 1 - Kanto (ID 1-151)</option>
                                <option value="gen2">Gen 2 - Johto (ID 152-251)</option>
                                <option value="gen3">Gen 3 - Hoenn (ID 252-386)</option>
                                <option value="gen4">Gen 4 - Sinnoh (ID 387-493)</option>
                                <option value="gen5">Gen 5 - Unova (ID 494-649)</option>
                                <option value="gen6">Gen 6 - Kalos (ID 650-721)</option>
                                <option value="gen7">Gen 7 - Alola (ID 722-809)</option>
                                <option value="gen8">Gen 8 - Galar (ID 810-905)</option>
                                <option value="gen9">Gen 9 - Paldea (ID 906+)</option>
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-neutral-500 group-hover:text-neutral-300 transition">
                                <i class="ph-bold ph-caret-up-down"></i>
                            </div>
                        </div>
                    </div>
    
                    <!-- Quantity Input -->
                    <div class="w-full md:col-span-1 lg:col-span-1" id="quantity-wrapper">
                        <label for="countInput" class="block text-xs font-semibold text-neutral-400 uppercase tracking-wider mb-2 ml-1">Quantity</label>
                        <div class="relative group">
                            <input type="number" id="countInput" value="6" min="1" max="20" 
                                class="w-full bg-black border border-neutral-700 text-neutral-200 text-sm rounded-xl px-4 py-3 focus:ring-2 focus:ring-red-500/50 focus:border-red-500 focus:outline-none transition text-center font-mono shadow-sm group-hover:border-neutral-600">
                        </div>
                    </div>
                    
                    <!-- Randomize Button -->
                    <div class="w-full md:col-span-1 lg:col-span-2 flex items-end">
                        <button onclick="generateData()" id="action-btn" class="w-full bg-gradient-to-br from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-red-900/50 transition-all duration-200 transform active:scale-95 flex items-center justify-center gap-2">
                            <i class="ph-fill ph-shuffle text-xl"></i> Randomize Pokémon
                        </button>
                    </div>
                </div>

                <!-- Type Filter Section -->
                <div class="w-full md:col-span-3 lg:col-span-5" id="type-filter-wrapper">
                    <label class="block text-xs font-semibold text-neutral-400 uppercase tracking-wider mb-2 ml-1">Type Filter (Optional)</label>
                    <div id="type-filter-grid" class="flex flex-wrap gap-2 p-3 bg-black/50 border border-neutral-700 rounded-xl max-h-40 overflow-y-auto">
                        <!-- Type buttons will be injected here by renderTypeFilters -->
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Result Display Area -->
        <div id="results-area" class="mt-8">
            <h2 id="results-title" class="text-xl font-bold text-white mb-4 hidden"></h2>
            <div id="loader" class="flex justify-center items-center py-10 hidden">
                <div class="pokeball-spinner mr-4"></div>
                <p id="loader-message" class="text-lg font-semibold text-neutral-400">Initializing data...</p>
            </div>
            <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Data Cards will be injected here -->
            </div>
            <div id="quiz-container" class="hidden">
                <!-- Quiz content will be injected here -->
            </div>
        </div>
        
        <!-- Custom Alert Modal -->
        <div id="custom-alert" class="fixed inset-0 bg-black/80 z-[100] flex justify-center items-center p-4 hidden transition-opacity duration-300 opacity-0" onclick="hideAlert()">
            <div class="bg-neutral-900 border border-yellow-500/50 rounded-xl p-6 w-full max-w-sm shadow-2xl" onclick="event.stopPropagation()">
                <div class="flex items-center text-yellow-400 mb-3">
                    <i class="ph-fill ph-warning-circle text-2xl mr-2"></i>
                    <h3 class="font-bold text-lg">Heads Up!</h3>
                </div>
                <p id="alert-message" class="text-sm text-neutral-300"></p>
                <button class="mt-4 w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded-lg transition" onclick="hideAlert()">
                    OK
                </button>
            </div>
        </div>

        <div id="status-message" class="text-center text-sm text-neutral-500 mt-8">
            Select your filter and press "Randomize Pokémon" to begin!
        </div>

    </main>

    <!-- Footer (simple dark footer) -->
    <footer class="bg-neutral-900/80 border-t border-neutral-800 mt-12 py-4 text-center">
        <p class="text-sm text-neutral-600">&copy; 2025 PokéRandomizer Z-A | Data from PokeAPI</p>
    </footer>

    <script>
        // --- CONSTANTS AND STATE ---
        const POKEAPI_BASE_URL = 'https://pokeapi.co/api/v2';
        const ALL_TYPES = ["normal", "fire", "water", "electric", "grass", "ice", "fighting", "poison", "ground", "flying", "psychic", "bug", "rock", "ghost", "dragon", "dark", "steel", "fairy"];
        
        // Data ranges for filtering the full Pokémon index (Pokedex ID based)
        const GENERATION_RANGES = {
            "gen1": { min: 1, max: 151 }, "gen2": { min: 152, max: 251 }, "gen3": { min: 252, max: 386 },
            "gen4": { min: 387, max: 493 }, "gen5": { min: 494, max: 649 }, "gen6": { min: 650, max: 721 },
            "gen7": { min: 722, max: 809 }, "gen8": { min: 810, max: 905 }, 
            // Gen 9 max is dynamic, so we cap at a reasonable number for the API index limit.
            "gen9": { min: 906, max: 1025 }, 
            "all": { min: 1, max: 1025 }
        };

        
        // Runtime state
        let allPokemonIndex = []; // { id, name, url } for all Pokémon
        let typeData = {}; // { typeName: [pokemonId1, pokemonId2, ...], ...}
        let allAbilities = []; // Will be fetched from API
        let allItems = []; // Will be fetched from API
        let allMoves = []; // Will be fetched from API
        let currentMainTab = 'randomizer';
        let currentSubTab = 'pokemon';
        let selectedTypes = new Set();
        let quizState = {
            currentPokemon: null,
            correctAnswer: null,
            options: [],
            isAnswered: false,
        };

        // --- API HELPERS ---

        /**
         * Generic fetch utility with error handling.
         */
        async function apiFetch(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                }
                return await response.json();
            } catch (error) {
                console.error("API Fetch Error:", error);
                alertUser(`Failed to fetch data from the API. Check console for details. (${error.message})`);
                throw error;
            }
        }

        /**
         * Step 1: Fetches the list of ALL Pokémon names and URLs. Runs once on load.
         */
        async function fetchPokemonIndex() {
            const indexUrl = `${POKEAPI_BASE_URL}/pokemon?limit=${GENERATION_RANGES.all.max}`;
            const data = await apiFetch(indexUrl);
            
            if (data && data.results) {
                // Map results to { id, name, url } and filter out non-standard forms based on URL ID
                allPokemonIndex = data.results.map((p, index) => ({
                    id: index + 1,
                    name: formatApiName(p.name),
                    url: p.url
                })).filter(p => p.id <= GENERATION_RANGES.all.max);
            }
        }

        /**
         * Step 1b: Fetches the list of Pokémon associated with each Type. Runs once on load.
         */
        async function fetchTypeIndex() {
            const typePromises = ALL_TYPES.map(async (type) => {
                const url = `${POKEAPI_BASE_URL}/type/${type}`;
                const data = await apiFetch(url);
                
                if (data && data.pokemon) {
                    // Extract Pokémon IDs from the URL and return as a set for quick lookup
                    const ids = new Set(data.pokemon.map(p => {
                        // URLs look like: https://pokeapi.co/api/v2/pokemon/1/
                        const urlParts = p.pokemon.url.split('/');
                        return parseInt(urlParts[urlParts.length - 2]);
                    }).filter(id => id <= GENERATION_RANGES.all.max)); // Filter by our max Pokedex ID
                    return { type, ids };
                }
                return { type, ids: new Set() };
            });

            const results = await Promise.all(typePromises);
            results.forEach(res => {
                typeData[res.type] = res.ids;
            });
        }

        /**
         * Step 1c: Fetches and processes data for abilities, moves, and items.
         */
        async function fetchOtherData() {
            // Fetch Abilities
            const abilitiesData = await apiFetch(`${POKEAPI_BASE_URL}/ability?limit=300`); // ~298 abilities
            const abilityPromises = abilitiesData.results.map(ability => apiFetch(ability.url));
            const abilitiesDetails = await Promise.all(abilityPromises);
            allAbilities = abilitiesDetails.map(a => ({
                name: a.name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
                description: a.effect_entries.find(e => e.language.name === 'en')?.short_effect || 'No description available.'
            }));

            // Fetch Items
            const itemsData = await apiFetch(`${POKEAPI_BASE_URL}/item?limit=1000`); // ~950+ items
            const itemPromises = itemsData.results.map(item => apiFetch(item.url));
            const itemDetails = await Promise.all(itemPromises);
            allItems = itemDetails
                .filter(i => i.attributes.some(attr => attr.name === 'holdable')) // Only holdable items
                .map(i => ({
                    name: i.name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
                    description: i.effect_entries.find(e => e.language.name === 'en')?.short_effect || 'No description available.'
                }));

            // Fetch Moves
            const movesData = await apiFetch(`${POKEAPI_BASE_URL}/move?limit=1000`); // ~900+ moves
            const movePromises = movesData.results.map(move => apiFetch(move.url));
            const moveDetails = await Promise.all(movePromises);
            allMoves = moveDetails.map(m => ({
                name: m.name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '),
                description: m.effect_entries.find(e => e.language.name === 'en')?.short_effect?.replace('$effect_chance', m.effect_chance) || 'No description available.',
                type: m.type.name.charAt(0).toUpperCase() + m.type.name.slice(1),
                category: m.damage_class.name.charAt(0).toUpperCase() + m.damage_class.name.slice(1),
                power: m.power ?? '-',
                accuracy: m.accuracy ?? '-'
            }));
        }

        /**
         * Capitalizes and formats names from the API (e.g., "close-combat" -> "Close Combat").
         */
        function formatApiName(name) {
            if (!name) return '';
            return name
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
        
        /**
         * Step 2: Fetches the detailed data for a single Pokémon ID.
         */
        async function fetchPokemonDetails(id) {
            const url = `${POKEAPI_BASE_URL}/pokemon/${id}`;
            const data = await apiFetch(url);

            if (!data) return null;

            // Simplify and normalize data structure
            const normalizedData = {
                id: data.id,
                name: formatApiName(data.name),
                primaryType: data.types[0].type.name,
                secondaryType: data.types.length > 1 ? data.types[1].type.name : null,
                stats: {
                    hp: data.stats.find(s => s.stat.name === 'hp').base_stat,
                    atk: data.stats.find(s => s.stat.name === 'attack').base_stat,
                    def: data.stats.find(s => s.stat.name === 'defense').base_stat,
                    satk: data.stats.find(s => s.stat.name === 'special-attack').base_stat,
                    sdef: data.stats.find(s => s.stat.name === 'special-defense').base_stat,
                    spd: data.stats.find(s => s.stat.name === 'speed').base_stat,
                },
                // Use the official front default sprite
                spriteUrl: data.sprites.front_default || data.sprites.other['official-artwork'].front_default,
                // Assume generation is derived from ID for filtering logic consistency
                generation: getPokemonGeneration(data.id),
            };

            return normalizedData;
        }

        /**
         * Filters the global index based on user selections.
         * Returns an array of { id, name } objects.
         */
        function filterPokemonIndex() {
            const generationFilter = document.getElementById('genSelect').value;
            const range = GENERATION_RANGES[generationFilter] || GENERATION_RANGES['all'];
            
            // 1. Filter by Generation (ID range)
            let filteredByIndex = allPokemonIndex.filter(p => 
                p.id >= range.min && p.id <= range.max
            );

            // 2. Filter by Type
            if (selectedTypes.size > 0) {
                // Get the union of all Pokémon IDs associated with the selected types
                let matchingIds = new Set();
                selectedTypes.forEach(type => {
                    const idsForType = typeData[type];
                    if (idsForType) {
                        idsForType.forEach(id => matchingIds.add(id));
                    }
                });
                
                // Filter the generation-filtered list to only include Pokémon whose ID is in the matchingIds set
                filteredByIndex = filteredByIndex.filter(p => matchingIds.has(p.id));
            }

            return filteredByIndex;
        }
        
        // --- UTILITY FUNCTIONS ---
        
        // Determine the generation based on Pokedex ID
        function getPokemonGeneration(id) {
            for (const gen in GENERATION_RANGES) {
                if (gen !== 'all' && id >= GENERATION_RANGES[gen].min && id <= GENERATION_RANGES[gen].max) {
                    return parseInt(gen.replace('gen', ''));
                }
            }
            return 9; // Default to Gen 9 if range is dynamic or unknown
        }

        function alertUser(message) {
            document.getElementById('alert-message').textContent = message;
            const alertModal = document.getElementById('custom-alert');
            alertModal.classList.remove('hidden', 'opacity-0');
            alertModal.classList.add('opacity-100');
        }

        function hideAlert() {
            const alertModal = document.getElementById('custom-alert');
            alertModal.classList.remove('opacity-100');
            alertModal.classList.add('opacity-0');
            setTimeout(() => {
                alertModal.classList.add('hidden');
            }, 300);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getRandomElements(arr, count) {
            if (!arr || arr.length === 0) return [];
            
            if (count >= arr.length) {
                return shuffleArray(arr.slice(0));
            }

            // Simple random selection without modifying original array
            const selected = [];
            const tempArr = arr.slice(); // Copy array
            while (selected.length < count) {
                const randomIndex = Math.floor(Math.random() * tempArr.length);
                selected.push(tempArr.splice(randomIndex, 1)[0]);
            }
            return selected;
        }

        // random blob shape for backgrounds
        function generateRandomBlobPath() {
            let path = `M 50 ${10 + Math.random() * 10} C`;
            const points = 8; 
            
            for (let i = 0; i < points; i++) {
                const angle = (i / points) * 2 * Math.PI;
                const nextAngle = ((i + 1) / points) * 2 * Math.PI;
                
                const radius1 = 30 + Math.random() * 20;
                const x1 = 50 + radius1 * Math.cos(angle);
                const y1 = 50 + radius1 * Math.sin(angle);
                
                const ctrlRadius1 = radius1 + (Math.random() * 10 - 5);
                const ctrlX1 = 50 + ctrlRadius1 * Math.cos(angle + Math.PI / points * 0.5);
                const ctrlY1 = 50 + ctrlRadius1 * Math.sin(angle + Math.PI / points * 0.5);

                const ctrlRadius2 = radius1 + (Math.random() * 10 - 5);
                const ctrlX2 = 50 + ctrlRadius2 * Math.cos(nextAngle - Math.PI / points * 0.5);
                const ctrlY2 = 50 + ctrlRadius2 * Math.sin(nextAngle - Math.PI / points * 0.5);
                
                let x2, y2;
                if (i === points - 1) {
                    x2 = 50;
                    y2 = 10 + Math.random() * 10;
                } else {
                    const radius2 = 30 + Math.random() * 20;
                    x2 = 50 + radius2 * Math.cos(nextAngle);
                    y2 = 50 + radius2 * Math.sin(nextAngle);
                }

                path += `${ctrlX1} ${ctrlY1}, ${ctrlX2} ${ctrlY2}, ${x2} ${y2} `;
            }

            path += 'Z'; 
            return path;
        }

        function renderStat(label, value, colorClass) {
            const widthPercentage = Math.min(100, (value / 255) * 100); // Max stat is 255 (Blissey's HP)

            return `
                <div class="bg-black/50 p-3 rounded-xl border border-neutral-700/70 shadow-inner shadow-black/50 group hover:bg-black transition">
                    <p class="text-xs font-medium text-neutral-400 uppercase tracking-widest mb-1">${label}</p>
                    <p class="text-lg font-extrabold text-white mb-2">${value}</p>
                    <!-- Stat Bar -->
                    <div class="h-1.5 w-full bg-neutral-800 rounded-full overflow-hidden">
                        <div class="h-full ${colorClass} transition-all duration-500 ease-out" style="width: ${widthPercentage}%;"></div>
                    </div>
                </div>
            `;
        }

        function createPokemonCard(pokemon) {
            const secondaryTypeHtml = pokemon.secondaryType 
                ? `<span class="type-bg-${pokemon.secondaryType} text-xs font-semibold px-2 py-0.5 rounded-full uppercase shadow-sm">${pokemon.secondaryType}</span>`
                : '';
            
            const blobPath = generateRandomBlobPath();

            return `
                <div class="pokemon-card bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden shadow-xl shadow-black/70 animate-fade-in relative transition-all duration-300 hover:scale-[1.01] hover:border-red-500/50">
                    
                    <!-- Top Section: Sprite and Blob Background -->
                    <div class="relative pt-12 pb-6 px-6 bg-neutral-950/50 flex flex-col items-center justify-end h-52">
                        
                        <!-- The Blob SVG Background -->
                        <div class="absolute inset-0 opacity-10 blur-md scale-150 transition-transform duration-500">
                            <svg class="h-full w-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <path d="${blobPath}" fill="currentColor" class="type-text-${pokemon.primaryType} transition-colors duration-500"/>
                            </svg>
                        </div>
                        
                        <!-- Dex Number -->
                        <div class="absolute top-4 left-6 text-xs font-mono text-neutral-600 font-bold z-10">
                            #${String(pokemon.id).padStart(4, '0')}
                        </div>

                        <!-- Sprite -->
                        <img src="${pokemon.spriteUrl}" alt="${pokemon.name}" 
                            onerror="this.onerror=null;this.src='https://placehold.co/128x128/171717/999999?text=Sprite%20N/A'"
                            class="w-32 h-32 object-contain z-20 drop-shadow-lg transform transition-transform duration-300 hover:scale-110"
                        >
                    </div>

                    <!-- Bottom Section: Info and Stats -->
                    <div class="p-6">
                        <!-- Name and Types -->
                        <h3 class="text-3xl font-extrabold text-white mb-2 leading-tight">${pokemon.name}</h3>
                        <div class="flex items-center gap-2 mb-4">
                            <span class="type-bg-${pokemon.primaryType} text-xs font-semibold px-2 py-0.5 rounded-full uppercase shadow-sm">${pokemon.primaryType}</span>
                            ${secondaryTypeHtml}
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-3 gap-3 text-center">
                            ${renderStat("HP", pokemon.stats.hp, "bg-green-500")}
                            ${renderStat("ATK", pokemon.stats.atk, "bg-red-500")}
                            ${renderStat("DEF", pokemon.stats.def, "bg-yellow-500")}
                            ${renderStat("SP ATK", pokemon.stats.satk, "bg-blue-500")}
                            ${renderStat("SP DEF", pokemon.stats.sdef, "bg-teal-500")}
                            ${renderStat("SPD", pokemon.stats.spd, "bg-purple-500")}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // generic card for items/abilities/moves
        function createDataCard(data, iconClass) {
            let detailHtml = '';
            if (currentSubTab === 'moves') {
                const typeColor = data.type ? data.type.toLowerCase() : 'normal';
                detailHtml = `
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="type-bg-${typeColor} text-xs font-semibold px-2 py-0.5 rounded-full uppercase text-white shadow-sm">${data.type}</span>
                        <span class="bg-neutral-800 text-neutral-300 text-xs font-semibold px-2 py-0.5 rounded-full shadow-sm">${data.category}</span>
                        <span class="bg-neutral-800 text-neutral-300 text-xs font-semibold px-2 py-0.5 rounded-full shadow-sm">PWR: ${data.power}</span>
                        <span class="bg-neutral-800 text-neutral-300 text-xs font-semibold px-2 py-0.5 rounded-full shadow-sm">ACC: ${data.accuracy}</span>
                    </div>
                `;
            }
            
            const title = data.name;

            return `
                <div class="data-card p-6 bg-neutral-900 rounded-2xl border border-neutral-800 shadow-xl shadow-black/70 animate-fade-in relative transition-all duration-300 hover:border-red-500/50">
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="text-2xl font-bold text-white leading-tight">${title}</h3>
                        <i class="${iconClass} text-red-500 text-2xl mt-1"></i>
                    </div>
                    ${detailHtml}
                    <p class="text-sm text-neutral-400 mt-2">${data.description}</p>
                </div>
            `;
        }

        // detail row for super random card
        function renderDetailSection(label, name, description, iconClass) {
            if (!name) return '';
            
            return `
                <div class="flex flex-col border-b border-neutral-800 last:border-b-0 pb-3">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="${iconClass} text-red-500 text-lg"></i>
                        <p class="text-xs font-semibold text-neutral-400 uppercase tracking-wider">${label}</p>
                    </div>
                    <p class="text-lg font-bold text-neutral-200">${name}</p>
                    <p class="text-xs text-neutral-500 line-clamp-2">${description}</p>
                </div>
            `;
        }

        // full card with pokemon + item + ability + move
        function createSuperRandomPokeCard(data) {
            const pokemon = data.pokemon;
            const secondaryTypeHtml = pokemon.secondaryType 
                ? `<span class="type-bg-${pokemon.secondaryType} text-xs font-semibold px-2 py-0.5 rounded-full uppercase shadow-sm">${pokemon.secondaryType}</span>`
                : '';
            const blobPath = generateRandomBlobPath();

            // Format move details
            const move = data.move;
            const moveType = move.type ? move.type.toLowerCase() : 'normal';
            const moveDetails = move.type && move.category && move.power && move.accuracy ? 
                ` | Type: <span class="type-bg-${moveType} text-white font-medium px-2 py-0.5 rounded-full">${move.type}</span> | Cat: <span class="font-medium">${move.category}</span> | Pwr: <span class="font-medium">${move.power}</span>` : 
                '';

            return `
                <div class="super-random-card bg-neutral-900 border border-neutral-800 rounded-2xl overflow-hidden shadow-xl shadow-black/70 animate-fade-in relative transition-all duration-300 hover:scale-[1.01] hover:border-red-500/50">
                    
                    <!-- Header Section (Pokemon Info) -->
                    <div class="relative pt-12 pb-6 px-6 bg-neutral-950/50 flex flex-col items-center justify-end h-52">
                        <!-- Blob SVG Background -->
                        <div class="absolute inset-0 opacity-10 blur-md scale-150 transition-transform duration-500">
                            <svg class="h-full w-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <path d="${blobPath}" fill="currentColor" class="type-text-${pokemon.primaryType} transition-colors duration-500"/>
                            </svg>
                        </div>
                        
                        <div class="absolute top-4 left-6 text-xs font-mono text-neutral-600 font-bold z-10">
                            #${String(pokemon.id).padStart(4, '0')}
                        </div>
                        <img src="${pokemon.spriteUrl}" alt="${pokemon.name}" 
                            onerror="this.onerror=null;this.src='https://placehold.co/128x128/171717/999999?text=Sprite%20N/A'"
                            class="w-32 h-32 object-contain z-20 drop-shadow-lg"
                        >
                    </div>

                    <!-- Body Section (Name, Types, Details) -->
                    <div class="p-6">
                        <h3 class="text-3xl font-extrabold text-white mb-2 leading-tight">${pokemon.name}</h3>
                        <div class="flex items-center gap-2 mb-6">
                            <span class="type-bg-${pokemon.primaryType} text-xs font-semibold px-2 py-0.5 rounded-full uppercase shadow-sm">${pokemon.primaryType}</span>
                            ${secondaryTypeHtml}
                        </div>

                        <div class="space-y-4">
                            <!-- Render Item -->
                            ${renderDetailSection("Held Item", data.item.name, data.item.description, "ph-fill ph-bag")}
                            <!-- Render Ability -->
                            ${renderDetailSection("Ability", data.ability.name, data.ability.description, "ph-fill ph-lightning")}
                            <!-- Render Move (Signature Move only) -->
                            ${renderDetailSection("Signature Move", data.move.name, data.move.description + moveDetails, "ph-fill ph-sword")}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- TYPE FILTER LOGIC ---

        function toggleTypeFilter(type, button) {
            type = type.toLowerCase();
            if (selectedTypes.has(type)) {
                selectedTypes.delete(type);
                button.classList.remove(`type-bg-${type}`, 'text-white', 'ring-2', 'ring-offset-2', 'ring-offset-black', 'ring-red-500');
                button.classList.add('bg-neutral-800', 'text-neutral-400', 'hover:bg-neutral-700');
            } else {
                selectedTypes.add(type);
                button.classList.add(`type-bg-${type}`, 'text-white', 'ring-2', 'ring-offset-2', 'ring-offset-black', 'ring-red-500');
                button.classList.remove('bg-neutral-800', 'text-neutral-400', 'hover:bg-neutral-700');
            }
        }

        function renderTypeFilters() {
            const container = document.getElementById('type-filter-grid');
            if (!container) return;
            
            container.innerHTML = ALL_TYPES.map(type => {
                const isSelected = selectedTypes.has(type);
                const baseClasses = 'type-filter-btn flex-shrink-0 text-xs font-bold uppercase px-3 py-1.5 rounded-full transition-all duration-200';
                const selectedClasses = isSelected 
                    ? `type-bg-${type} text-white ring-2 ring-offset-2 ring-offset-black ring-red-500` 
                    : 'bg-neutral-800 text-neutral-400 hover:bg-neutral-700';

                return `
                    <button type="button" 
                        onclick="toggleTypeFilter('${type}', this)"
                        class="${baseClasses} ${selectedClasses}"
                    >
                        ${type}
                    </button>
                `;
            }).join('');
        }

        // --- QUIZ FUNCTIONS ---

        async function generateQuiz() {
            // Setup loading state
            const loader = document.getElementById('loader');
            const loaderMessage = document.getElementById('loader-message');
            const quizContainer = document.getElementById('quiz-container');
            const actionBtn = document.getElementById('action-btn');
            
            quizContainer.innerHTML = '';
            loaderMessage.textContent = 'Preparing quiz question...';
            loader.classList.remove('hidden');
            actionBtn.disabled = true;

            // 1. Filter the index by difficulty
            const difficulty = document.getElementById('quizDifficulty').value;
            let difficultyRange = { min: 1, max: 1025 };
            if (difficulty === 'easy') difficultyRange = { min: 1, max: 386 };
            if (difficulty === 'medium') difficultyRange = { min: 387, max: 721 };
            if (difficulty === 'hard') difficultyRange = { min: 722, max: 1025 };

            const filteredIndex = allPokemonIndex.filter(p => 
                p.id >= difficultyRange.min && p.id <= difficultyRange.max
            );

            if (filteredIndex.length < 4) {
                 alertUser(`Not enough Pokémon (${filteredIndex.length}) for the selected difficulty. Please select 'National Dex' or adjust the range.`);
                 loader.classList.add('hidden');
                 actionBtn.disabled = false;
                 return;
            }

            quizState.isAnswered = false;
            
            // 2. Select 4 unique IDs (1 answer + 3 decoys)
            const quizIndex = getRandomElements(filteredIndex, 4);
            const answerIndex = Math.floor(Math.random() * 4);
            const answerPokemonIndex = quizIndex[answerIndex];

            // 3. Fetch detailed data for the answer Pokémon
            try {
                const answerPokemonDetails = await fetchPokemonDetails(answerPokemonIndex.id);
                if (!answerPokemonDetails) throw new Error('Failed to load Pokémon details for quiz.');

                quizState.currentPokemon = answerPokemonDetails;
                quizState.correctAnswer = answerPokemonDetails.name;
                
                // 4. Set up options
                quizState.options = shuffleArray(quizIndex.map(p => p.name));
                
                // 5. Render
                renderQuizContent();
            } catch (error) {
                console.error("Quiz Generation Error:", error);
                alertUser('Failed to load quiz data. Please try again.');
            } finally {
                loader.classList.add('hidden');
                actionBtn.disabled = false;
            }
        }

        function checkAnswer(selectedOption, buttonElement) {
            if (quizState.isAnswered) return;
            
            quizState.isAnswered = true;
            const isCorrect = selectedOption === quizState.correctAnswer;
            
            const buttons = document.querySelectorAll('#quiz-container button');
            buttons.forEach(button => {
                const buttonText = button.getAttribute('data-name');
                button.disabled = true;

                if (buttonText === quizState.correctAnswer) {
                    button.classList.remove('bg-neutral-800/50', 'hover:bg-neutral-700/50');
                    button.classList.add('bg-green-600', 'hover:bg-green-500', 'ring-2', 'ring-green-400');
                } else if (buttonText === selectedOption && !isCorrect) {
                    button.classList.remove('bg-neutral-800/50', 'hover:bg-neutral-700/50');
                    button.classList.add('bg-red-600', 'hover:bg-red-500', 'ring-2', 'ring-red-400');
                } else {
                    button.classList.remove('bg-neutral-800/50', 'hover:bg-neutral-700/50');
                    button.classList.add('bg-neutral-700/30');
                }
            });

            document.getElementById('pokemon-silhouette').classList.add('revealed');
            
            const resultMessage = document.getElementById('quiz-result-message');
            if (isCorrect) {
                resultMessage.innerHTML = '<i class="ph-fill ph-check-circle text-green-500 text-2xl mr-2"></i> Excellent! That\'s ' + quizState.correctAnswer + '!';
                resultMessage.classList.remove('text-red-500', 'hidden');
                resultMessage.classList.add('text-green-500');
            } else {
                resultMessage.innerHTML = '<i class="ph-fill ph-x-circle text-red-500 text-2xl mr-2"></i> Incorrect. It was ' + quizState.correctAnswer + '.';
                resultMessage.classList.remove('text-green-500', 'hidden');
                resultMessage.classList.add('text-red-500');
            }
            
            const actionBtn = document.getElementById('action-btn');
            actionBtn.innerHTML = '<i class="ph-fill ph-arrow-right text-xl"></i> Next Quiz';
            actionBtn.onclick = generateQuiz;
        }

        function renderQuizContent() {
            const container = document.getElementById('quiz-container');
            const pokemon = quizState.currentPokemon;

            const buttonHtml = quizState.options.map(name => `
                <button onclick="checkAnswer('${name}', this)" data-name="${name}"
                    class="w-full bg-neutral-800/50 hover:bg-neutral-700/50 text-white font-semibold py-4 px-6 rounded-xl transition duration-200 shadow-lg shadow-black/30 text-lg text-left disabled:opacity-70 disabled:cursor-not-allowed"
                >
                    ${name}
                </button>
            `).join('');

            container.innerHTML = `
                <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-8 shadow-2xl shadow-black/80 animate-fade-in">
                    <h2 class="text-3xl font-extrabold text-red-500 mb-6 flex items-center gap-3">
                        <i class="ph-fill ph-question text-3xl"></i> Who's That Pokémon?
                    </h2>

                    <div class="bg-neutral-950 border border-neutral-800 rounded-xl p-8 mb-8 flex justify-center items-center h-64 relative">
                        <img id="pokemon-silhouette" 
                            src="${pokemon.spriteUrl}" 
                            alt="Who's that Pokemon?" 
                            class="w-48 h-48 object-contain silhouette"
                            onerror="this.onerror=null;this.src='https://placehold.co/192x192/171717/999999?text=Sprite%20N/A'"
                        >
                        <div class="absolute top-4 right-4 text-xs font-mono text-neutral-600 font-bold">
                            Gen ${pokemon.generation}
                        </div>
                    </div>

                    <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${buttonHtml}
                    </div>

                    <p id="quiz-result-message" class="mt-6 text-center text-lg font-bold hidden"></p>
                </div>
            `;
            
            const actionBtn = document.getElementById('action-btn');
            actionBtn.innerHTML = '<i class="ph-fill ph-arrow-right text-xl"></i> Skip & Next Quiz';
            actionBtn.onclick = generateQuiz;
            
            document.getElementById('status-message').classList.add('hidden');
        }

        // --- MAIN DATA GENERATION ---

        async function generateData() {
            if (currentMainTab === 'quiz') {
                generateQuiz();
                return;
            }

            const loader = document.getElementById('loader');
            const loaderMessage = document.getElementById('loader-message');
            const resultsContainer = document.getElementById('results-container');
            const statusMessage = document.getElementById('status-message');
            const resultsTitle = document.getElementById('results-title');
            const count = parseInt(document.getElementById('countInput').value) || 6;
            
            resultsContainer.innerHTML = '';
            statusMessage.classList.add('hidden');
            resultsTitle.classList.add('hidden');
            loaderMessage.textContent = 'Catching Pokémon...';
            loader.classList.remove('hidden');
            document.getElementById('action-btn').disabled = true;

            let randomizedData = [];
            let htmlContent = '';
            let titleText = '';

            // Reset grid columns for non-superRandomPoke tabs
            resultsContainer.classList.add('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
            resultsContainer.classList.remove('lg:grid-cols-2', 'xl:grid-cols-3'); 
            
            try {
                if (currentSubTab === 'pokemon' || currentMainTab === 'team' || currentSubTab === 'superRandomPoke') {
                    // 1. Filter the global index based on Generation and Type
                    const filteredIndex = filterPokemonIndex();

                    if (filteredIndex.length === 0) {
                        htmlContent = `<div class="md:col-span-2 lg:col-span-3 text-center py-10 text-lg text-neutral-500">
                            No Pokémon found matching the selected Generation and Type filters. Please adjust your criteria.
                        </div>`;
                        throw new Error("No Pokémon found.");
                    }

                    // 2. Determine final count and select random IDs from the filtered index
                    const finalCount = currentMainTab === 'team' ? 6 : count;
                    const randomPokemonIndexSelection = getRandomElements(filteredIndex, finalCount);

                    // 3. Fetch details for all selected Pokémon in parallel
                    const detailPromises = randomPokemonIndexSelection.map(p => fetchPokemonDetails(p.id));
                    const detailedPokemon = (await Promise.all(detailPromises)).filter(p => p !== null);

                    if (currentSubTab === 'superRandomPoke') {
                        titleText = `${finalCount} Complete Pokémon Random Setups:`;
                        
                        for (const pokemon of detailedPokemon) {
                            const randomAbility = getRandomElements(allAbilities, 1)[0];
                            const randomItem = getRandomElements(allItems, 1)[0];
                            const randomMove = getRandomElements(allMoves, 1)[0];

                            randomizedData.push({
                                pokemon: pokemon,
                                ability: randomAbility,
                                item: randomItem,
                                move: randomMove
                            });
                        }
                        resultsContainer.classList.remove('grid-cols-3');
                        resultsContainer.classList.add('lg:grid-cols-2', 'xl:grid-cols-3');
                        htmlContent = randomizedData.map(createSuperRandomPokeCard).join('');

                    } else { // pokemon or team tabs
                        titleText = currentMainTab === 'team' ? 'Your Randomized Team (6 Pokémon):' : `Your Randomized Pokémon Selection (${count}):`;
                        randomizedData = detailedPokemon;
                        htmlContent = randomizedData.map(createPokemonCard).join('');
                    }
                    
                } else if (currentSubTab === 'abilities') {
                    titleText = `${count} Random Abilities:`;
                    randomizedData = getRandomElements(allAbilities, count);
                    htmlContent = randomizedData.map(a => createDataCard(a, "ph-fill ph-lightning")).join('');

                } else if (currentSubTab === 'moves') {
                    titleText = `${count} Random Moves:`;
                    randomizedData = getRandomElements(allMoves, count);
                    htmlContent = randomizedData.map(m => createDataCard(m, "ph-fill ph-sword")).join('');

                } else if (currentSubTab === 'items') {
                    titleText = `${count} Random Items:`;
                    randomizedData = getRandomElements(allItems, count);
                    htmlContent = randomizedData.map(i => createDataCard(i, "ph-fill ph-bag")).join('');
                }
            } catch (error) {
                // Do nothing here, the alertUser handles the UI error message.
                console.error("Generate Data Error:", error);
            }

            // Apply final results
            loader.classList.add('hidden');
            document.getElementById('action-btn').disabled = false;
            if (htmlContent) {
                resultsTitle.innerHTML = titleText;
                resultsTitle.classList.remove('hidden');
                resultsContainer.innerHTML = htmlContent;
            }
        }

        // --- TAB SWITCHING ---

        function switchMainTab(tab) {
            currentMainTab = tab;

            document.querySelectorAll('.main-tab-btn').forEach(btn => {
                btn.classList.remove('bg-neutral-800', 'text-white', 'shadow-sm', 'ring-1', 'ring-white/10');
                btn.classList.add('text-neutral-400', 'hover:text-neutral-200', 'hover:bg-neutral-800/50');
            });
            document.getElementById(`main-tab-${tab}`).classList.add('bg-neutral-800', 'text-white', 'shadow-sm', 'ring-1', 'ring-white/10');
            document.getElementById(`main-tab-${tab}`).classList.remove('text-neutral-400', 'hover:text-neutral-200', 'hover:bg-neutral-800/50');

            const randomizerSubTabs = document.getElementById('randomizerSubTabs');
            const controlsRow = document.getElementById('controls-row');
            const quizControls = document.getElementById('quizControls');
            const quizContainer = document.getElementById('quiz-container');
            const resultsContainer = document.getElementById('results-container');
            const quantityWrapper = document.getElementById('quantity-wrapper');
            const actionBtn = document.getElementById('action-btn');
            const typeFilterWrapper = document.getElementById('type-filter-wrapper');
            
            resultsContainer.innerHTML = '';
            quizContainer.innerHTML = '';
            document.getElementById('status-message').classList.remove('hidden');
            document.getElementById('results-title').classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            quizContainer.classList.add('hidden');
            quizControls.classList.add('hidden');

            if (tab === 'randomizer') {
                randomizerSubTabs.classList.remove('hidden');
                controlsRow.classList.remove('hidden');
                quantityWrapper.classList.remove('hidden');
                switchSubTab('pokemon'); 
            } else if (tab === 'team') {
                randomizerSubTabs.classList.add('hidden');
                controlsRow.classList.remove('hidden');
                quantityWrapper.classList.add('hidden'); 
                document.getElementById('genSelect').parentElement.parentElement.classList.remove('hidden');
                typeFilterWrapper.classList.remove('hidden');
                
                actionBtn.innerHTML = '<i class="ph-fill ph-users-three text-xl"></i> Generate Team';
                actionBtn.onclick = generateData;
                document.getElementById('status-message').innerHTML = 'Generate a 6-mon team based on your filters!';
                
            } else if (tab === 'quiz') {
                randomizerSubTabs.classList.add('hidden');
                resultsContainer.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                controlsRow.classList.add('hidden');
                quizControls.classList.remove('hidden');
                
                actionBtn.innerHTML = '<i class="ph-fill ph-question text-xl"></i> Start Quiz';
                actionBtn.onclick = generateQuiz;
                document.getElementById('status-message').innerHTML = 'Select a difficulty and press "Start Quiz" to begin the guessing game!';
            }
        }

        function switchSubTab(tab) {
            currentSubTab = tab;

            if (currentMainTab !== 'randomizer') return;

            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('bg-neutral-800', 'text-white', 'shadow-sm');
                btn.classList.add('text-neutral-400', 'hover:text-neutral-200', 'hover:bg-neutral-800/50');
            });
            document.getElementById(`sub-tab-${tab}`).classList.add('bg-neutral-800', 'text-white', 'shadow-sm');
            document.getElementById(`sub-tab-${tab}`).classList.remove('text-neutral-400', 'hover:text-neutral-200', 'hover:bg-neutral-800/50');

            const actionBtn = document.getElementById('action-btn');
            const genSelectWrapper = document.getElementById('genSelect').parentElement.parentElement;
            const typeFilterWrapper = document.getElementById('type-filter-wrapper');

            document.getElementById('results-container').innerHTML = '';
            document.getElementById('status-message').classList.remove('hidden');
            document.getElementById('results-title').classList.add('hidden');
            
            document.getElementById('quantity-wrapper').classList.remove('hidden'); 

            let btnText = 'Randomize Data';
            let statusText = 'Select your quantity and press "Randomize Data" to begin!';

            const needsPokemonFilters = (tab === 'pokemon' || tab === 'superRandomPoke');

            if (needsPokemonFilters) {
                genSelectWrapper.classList.remove('hidden');
                typeFilterWrapper.classList.remove('hidden');
            } else {
                genSelectWrapper.classList.add('hidden');
                typeFilterWrapper.classList.add('hidden');
            }

            if (tab === 'pokemon') {
                btnText = 'Randomize Pokémon';
                statusText = 'Generate a random selection of Pokémon for your playthrough.';
            } else if (tab === 'abilities') {
                btnText = 'Randomize Abilities';
                statusText = 'Generate a list of random Abilities.';
            } else if (tab === 'moves') {
                btnText = 'Randomize Moves';
                statusText = 'Generate a list of random Moves.';
            } else if (tab === 'items') {
                btnText = 'Randomize Items';
                statusText = 'Generate a list of random Held Items.';
            } else if (tab === 'superRandomPoke') {
                btnText = 'Generate Random Setups';
                statusText = 'Generate a Pokémon with a random Item, Ability, and Signature Move.';
            }
            
            actionBtn.innerHTML = `<i class="ph-fill ph-shuffle text-xl"></i> ${btnText}`;
            document.getElementById('status-message').innerHTML = statusText;
            actionBtn.onclick = generateData; 
        }

        // --- INITIALIZATION ---
        async function initializeApp() {
            // Show initial loader for API setup
            const loader = document.getElementById('loader');
            const loaderMessage = document.getElementById('loader-message');
            loader.classList.remove('hidden');

            try {
                // 1. Fetch all required data in parallel
                loaderMessage.textContent = 'Fetching Pokémon index...';
                const pokemonIndexPromise = fetchPokemonIndex();
                loaderMessage.textContent = 'Fetching Type data...';
                const typeIndexPromise = fetchTypeIndex();
                loaderMessage.textContent = 'Fetching Abilities, Items, & Moves...';
                const otherDataPromise = fetchOtherData();
                await Promise.all([pokemonIndexPromise, typeIndexPromise, otherDataPromise]);

                // 2. Setup initial UI state
                switchMainTab('randomizer');
                switchSubTab('pokemon');
                renderTypeFilters();

                document.getElementById('status-message').textContent = 'Data initialized. Ready to randomize!';

            } catch (error) {
                alertUser('Initial API data load failed. Please check your connection or try again later.');
                // Disable the action button if initial load fails
                document.getElementById('action-btn').disabled = true;
                document.getElementById('status-message').textContent = 'Initialization failed. See console for API errors.';
            } finally {
                // Hide loader once setup is complete or failed
                loader.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>